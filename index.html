<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web AR</title>
    <link href="demo-styles.css" rel="stylesheet"/>
    <script defer src="https://github.com/lightlessdays/web-ar/blob/main/focus.js"></script>
    <script src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js" type="module"></script>
    <style>
        model-viewer {
            width: 100%;
            max-width: 600px;  /* Adjust to visually appealing width */
            margin: 40px auto;  /* Center the model-viewer */
            display: block;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        model-viewer:first-of-type {
            margin-top: 0;
        }
        model-viewer:last-of-type {
            margin-bottom: 0;
        }
        @media (max-width: 768px) {
            #card {
                padding-left: 80px;
                padding-right: 80px;
            }
        }
    </style>
</head>
<body>

<div id="card">
    <div style="text-align:center; margin-bottom: 20px;">
        <label for="mferID">Enter mfer ID: </label>
        <input id="mferID" placeholder="1234" type="text"/>
        <button onclick="filterModels()">Search</button>
        <button onclick="resetFilter()">Cancel</button>
    </div>

    <div id="models-container"></div>
</div>

<script type="module">
    const color_map = {
        "red": "ff7277",
        "green": "b7ff6c",
        "yellow": "5cd3ff",
        "orange": "feb66e",
        "blue": "5cd3ff",
        "tree": "ffe25f",
        "space": "898989",
        "graveyard": "7c7c7c"
    };

    async function fetchModels() {
        const response = await fetch("https://cybermfers.sfo3.digitaloceanspaces.com/?prefix=cybermfers/public/metadata/");
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");
        const keys = xmlDoc.getElementsByTagName("Key");
        const modelPairs = {};

        for (let i = 0; i < keys.length; i++) {
            const key = keys[i].textContent;
            const basename = key.split('.')[0];
            const ext = key.split('.')[1];

            if (ext === 'json') {
                const metadataUrl = `https://cybermfers.sfo3.digitaloceanspaces.com/${key}`;
                const metadataResponse = await fetch(metadataUrl);
                const metadata = await metadataResponse.json();

                const glb = metadata.animation_url;
                const usdz = metadata.usdz_url;
                const id = basename.split('/').pop();

                const container = document.getElementById("models-container");

                if (usdz && glb) {
                    const modelViewer = document.createElement("model-viewer");
                    modelViewer.setAttribute("src", glb);
                    modelViewer.setAttribute("ios-src", usdz);
                    modelViewer.setAttribute("alt", `${basename}`);
                    modelViewer.setAttribute("ar-status", "not-presenting");
                    modelViewer.setAttribute("shadow-intensity", "1");
                    modelViewer.setAttribute("camera-controls", "");
                    modelViewer.setAttribute("auto-rotate", "");
                    modelViewer.setAttribute("ar", "");
                    modelViewer.setAttribute("autoplay", "");
                    modelViewer.setAttribute("loop", "");

                    let bgColor = "FFFFFF";
                    const backgroundTrait = metadata.attributes.find(attr => attr.trait_type === "background");

                    if (backgroundTrait) {
                        bgColor = color_map[backgroundTrait.value] || "FFFFFF";
                    }
                    metadata.background_color = bgColor;

                    modelViewer.style.backgroundColor = `#${bgColor}`;
                    container.appendChild(modelViewer);

                    const detailLink = document.createElement("a");
                    detailLink.setAttribute("href", `details.html?id=${id}`);
                    detailLink.textContent = `view all mfer #${id}`;
                    container.appendChild(detailLink);
                }
            }
        }
    }

    window.onload = fetchModels;

</script>

<script>
    function filterModels() {
        const inputID = document.getElementById("mferID").value;
        const modelViewers = document.querySelectorAll("model-viewer");
        const detailLinks = document.querySelectorAll("a");
        
        // Reset visibility for all models before applying new filter
        modelViewers.forEach(mv => {
            mv.style.display = "block";
        });

        detailLinks.forEach(link => {
            link.style.display = "block";
        });

        // Apply the filter based on entered ID
        modelViewers.forEach(mv => {
            const src = mv.getAttribute("src");
            if (src && !src.includes(inputID)) {
                mv.style.display = "none";
            }
        });

        detailLinks.forEach(link => {
            const href = link.getAttribute("href");
            if (href && !href.includes(inputID)) {
                link.style.display = "none";
            }
        });
    }

    function resetFilter() {
        document.getElementById("mferID").value = "";
        const modelViewers = document.querySelectorAll("model-viewer");
        const detailLinks = document.querySelectorAll("a");
        modelViewers.forEach(mv => {
            mv.style.display = "block";
        });

        detailLinks.forEach(link => {
            link.style.display = "block";
        });
    }
</script>

</body>
</html>
