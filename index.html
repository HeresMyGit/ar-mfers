<!DOCTYPE html>
<html lang="en">
 <head>
  <!-- Google tag (gtag.js) -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DEMRCQSGLC">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DEMRCQSGLC');
  </script>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   mfer avatars
  </title>
  <link href="demo-styles.css" rel="stylesheet"/>
  <script defer="" src="https://github.com/lightlessdays/web-ar/blob/main/focus.js">
  </script>
  <script src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js" type="module">
  </script>
  <link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAK0lEQVQ4jWNgGAWjYBSMglEwCkbBSAcACBAAAeaR9MDwTVgZ4Q9II7CfSAb8DBhGwQgABJ5A8V7i4hkAAAAASUVORK5CYII=" rel="icon" type="image/png"/>
 </head>
 <body>
  <h1 style="text-align:center; margin: 20px 0;">
   mfer avatars
  </h1>
  <div style="text-align:center; margin: 20px 0;">
    <a href="https://www.mferavatars.xyz" style="margin: 20px 20px 40px 20px; padding: 10px 20px; background-color: #007BFF; color: #fff; border-radius: 5px; text-decoration: none; font-weight: bold;">
     Mint Here
 </a>

   <p>
     <a href="https://ar.mferavatars.xyz/customs.html" style="margin: 40px 20px 20px 20px; padding: 10px 20px; background-color: #007BFF; color: #fff; border-radius: 5px; text-decoration: none; font-weight: bold;">
      Custom mfer avatars
  </a>

   <h4 style="text-align:center; margin: 20px 0;">
    Open this page on your phone to view mfers in AR!
   </h4>
  </div>
  <div id="card">
   <div style="text-align:center; margin-bottom: 20px;">
    <label for="mferID">
     Enter mfer ID:
    </label>
    <input id="mferID" placeholder="1234" type="text"/>
    <button onclick="onSearchPressed()" style="">
     Search
    </button>
   </div>
   <div id="models-container">
   </div>
  </div>
  <script type="module">
   const color_map = {
        "red": "ff7277",
        "green": "b7ff6c",
        "yellow": "ffe25e",
        "orange": "feb66e",
        "blue": "5cd3ff",
        "tree": "ffe25f",
        "space": "898989",
        "graveyard": "7c7c7c"
    };

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    async function fetchModels() {
        const response = await fetch("https://cybermfers.sfo3.digitaloceanspaces.com/?prefix=cybermfers/public/metadata/");
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");

        // Convert HTMLCollection to array
        const keys = Array.from(xmlDoc.getElementsByTagName("Key"));

        // Shuffle the array
        shuffleArray(keys);

        const mintedMfers = {};

        for (let i = 0; i < keys.length; i++) {
            const key = keys[i].textContent;
            const basename = key.split('.')[0];
            const ext = key.split('.')[1];

            if (ext === 'json') {
                const metadataUrl = `https://cybermfers.sfo3.digitaloceanspaces.com/${key}`;
                const metadataResponse = await fetch(metadataUrl);
                const metadata = await metadataResponse.json();

                // Extract the ID from the basename
                const id = basename.split('/').pop();

                // const glb = metadata.animation_url;
                // const usdz = metadata.usdz_url;
                const glb = `https://cybermfers.sfo3.digitaloceanspaces.com/cybermfers/public/assets/extras/christmas/glb/${id}.glb`;
                const usdz = `https://cybermfers.sfo3.digitaloceanspaces.com/cybermfers/public/assets/extras/christmas/usdz/${id}.usdz`;

                const container = document.getElementById("models-container");

                if (usdz && glb) {
                    const modelViewer = document.createElement("model-viewer");
                    modelViewer.setAttribute("src", glb);
                    modelViewer.setAttribute("ios-src", usdz);
                    modelViewer.setAttribute("alt", `${basename}`);
                    modelViewer.setAttribute("ar-status", "not-presenting");
                    modelViewer.setAttribute("shadow-intensity", "1");
                    modelViewer.setAttribute("camera-controls", "");
                    modelViewer.setAttribute("auto-rotate", "");
                    modelViewer.setAttribute("ar", "");
                    modelViewer.setAttribute("autoplay", "");
                    modelViewer.setAttribute("loop", "");

                    let bgColor = "FFFFFF";
                    const backgroundTrait = metadata.attributes.find(attr => attr.trait_type === "background");

                    if (backgroundTrait) {
                        bgColor = color_map[backgroundTrait.value] || "FFFFFF";
                    }
                    metadata.background_color = bgColor;

                    modelViewer.style.backgroundColor = `#${bgColor}`;
                    container.appendChild(modelViewer);

                    const detailButton = document.createElement("button");
                    detailButton.onclick = function() { window.location.href = `details.html?id=${id}`; };
                    detailButton.textContent = `view all mfer #${id}`; detailButton.style.width = "calc(100% - 20px)"; detailButton.style.marginTop = "10px"; detailButton.style.padding = "10px"; detailButton.style.backgroundColor = "#007BFF"; detailButton.style.color = "#fff"; detailButton.style.border = "1px solid #ccc"; detailButton.style.cursor = "pointer"; detailButton.style.borderRadius = "5px"; detailButton.style.display = "block"; detailButton.style.marginLeft = "auto"; detailButton.style.marginRight = "auto";
                    container.appendChild(detailButton);
                }
            }
        }
    }

    window.onload = fetchModels;
  </script>
  <script>
   function onSearchPressed() {
        const id = document.getElementById("mferID").value;

        fetch('https://cybermfers.sfo3.digitaloceanspaces.com/?prefix=cybermfers/public/metadata/')
            .then(response => response.text())
            .then(data => {
                const parser = new DOMParser();
                const xml = parser.parseFromString(data, 'application/xml');
                const files = xml.querySelectorAll('Key');
                let fileFound = false;

                files.forEach(file => {
                    if (file.textContent === `cybermfers/public/metadata/${id}.json`) {
                        fileFound = true;
                    }
                });

                if (fileFound) {
                    window.location.href = `details.html?id=${id}`;
                } else {
                    window.location.href = `details.html?id=${id}&needsMint=true`;
                }
            })
            .catch(error => console.error('Error:', error));
    }
  </script>
 </body>
</html>
