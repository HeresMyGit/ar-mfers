<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title></title>
    <link href="demo-styles.css" rel="stylesheet">
    <style>
        model-viewer, #dynamicHeader {
            text-align: center;
            margin: 20px 0;
        }
        model-viewer {
            width: 100%;
            max-width: 600px;
            margin: 40px auto;
            display: block;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #download-buttons {
            text-align: center;
            margin: 20px 0;
            padding: 20px 0;  /* Vertical padding */
        }
        #download-buttons button {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 20px;  /* Vertical and horizontal padding */
        }
        #models-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #models-container button {
            margin: 5px; /* Adds some space between buttons */
            padding: 10px 20px;  /* Vertical and horizontal padding */
        }
        .model-container {
            width: 100%;
        }
        #mainHeader {
            text-align: center;
        }
        @media (max-width: 768px) {
            #card {
                padding-left: 80px;
                padding-right: 80px;
            }
        }
    </style>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DEMRCQSGLC"></script>
    <script defer src="https://github.com/lightlessdays/web-ar/blob/main/focus.js"></script>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script>
        window.addEventListener('load', function() {
            initializeGTag();
            setDynamicTitleAndHeader();
            const urlParams = new URLSearchParams(window.location.search);
            const needsMint = urlParams.has('needsMint') ? urlParams.get('needsMint') === 'true' : false;  // Default to false
            fetchModelDetails([
              { name: 'idle', fileTypes: ['GLB', 'USDZ'] },
              { name: 'christmas', fileTypes: ['GLB', 'USDZ', 'VRM', 'FBX'] },
              { name: 'winter', fileTypes: ['GLB', 'USDZ', 'VRM', 'FBX'] },
              { name: 'drone', fileTypes: ['GLB', 'USDZ', 'FBX']},
              { name: 'chrome', fileTypes: ['GLB', 'USDZ']},
              { name: 'chromefull', fileTypes: ['GLB', 'USDZ']}
              // ... other extra items ...
          ], needsMint);
        });

        function initializeGTag() {
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-DEMRCQSGLC');
        }

        function setDynamicTitleAndHeader() {
              const urlParams = new URLSearchParams(window.location.search);
              const isCustom = urlParams.get('custom') === 'true';

              const mainHeaderText = isCustom ? 'mfer avatars: customs' : 'mfer avatars';
              const mainHeaderURL = isCustom ? 'https://ar.mferavatars.xyz/customs' : 'https://ar.mferavatars.xyz';

              const mainHeaderElement = document.getElementById('mainHeader');
              if (mainHeaderElement) {
                  mainHeaderElement.href = mainHeaderURL;
                  mainHeaderElement.querySelector('h1').textContent = mainHeaderText;
              }

            const mferId = urlParams.get('id');

            if (mferId) {
                const titleText = isCustom ? 'custom mfer #' : 'mfer #';
                document.title = titleText + mferId;
                const headerElement = document.getElementById('dynamicHeader');
                if (headerElement) {
                    headerElement.textContent = titleText + mferId;
                }
            }
        }

        const color_map = {
            "red": "ff7277",
            "green": "b7ff6c",
            "yellow": "ffe25e",
            "orange": "feb66e",
            "blue": "5cd3ff",
            "tree": "ffe25f",
            "space": "898989",
            "graveyard": "7c7c7c"
        };

        async function fetchModelDetails(extraItems, needsMint = false) {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const isCustom = params.get('custom') === 'true';

            const urlPrefix = isCustom ?
                'https://cybermfers.sfo3.digitaloceanspaces.com/cybermfers/customs/' :
                'https://cybermfers.sfo3.digitaloceanspaces.com/cybermfers/';

            const publicOrPrivate = needsMint ? "private" : "public";
            const baseUrl = `${urlPrefix}${publicOrPrivate}/`;


            // Fetch metadata for the specific model
            const response = await fetch(`${baseUrl}metadata/${id}.json`);
            const metadata = await response.json();

            let bgColor = "FFFFFF";
            const backgroundTrait = metadata.attributes.find(attr => attr.trait_type === "background");
            if (backgroundTrait) {
                bgColor = color_map[backgroundTrait.value] || "FFFFFF";
            }

            // Set favicons
            const faviconLink = document.createElement('link');
            faviconLink.rel = 'icon';
            faviconLink.href = metadata.image;
            faviconLink.type = 'image/png';
            document.head.appendChild(faviconLink);

            const iosIconLink = document.createElement('link');
            iosIconLink.rel = 'apple-touch-icon';
            iosIconLink.href = metadata.image;
            document.head.appendChild(iosIconLink);

            // Create and set the manifest file for Android
            const manifestContent = {
                "icons": [
                    {
                        "src": metadata.image,
                        "sizes": "192x192",
                        "type": "image/png"
                    },
                    {
                        "src": metadata.image,
                        "sizes": "512x512",
                        "type": "image/png"
                    }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifestContent)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                manifestLink.href = manifestUrl;
            } else {
                const newManifestLink = document.createElement('link');
                newManifestLink.rel = 'manifest';
                newManifestLink.href = manifestUrl;
                document.head.appendChild(newManifestLink);
            }


            // Fetch and display the model
            const container = document.getElementById("models-container");
            const modelViewer = document.createElement("model-viewer");
            modelViewer.style.backgroundColor = `#${bgColor}`;
            modelViewer.setAttribute("src", `${baseUrl}assets/glb/${id}.glb`);
            modelViewer.setAttribute("ios-src", `${baseUrl}assets/usdz/${id}.usdz`);
            modelViewer.setAttribute("alt", `mfer #${id}`);
            modelViewer.setAttribute("ar-status", "not-presenting");
            modelViewer.setAttribute("shadow-intensity", "1");
            modelViewer.setAttribute("camera-controls", "");
            modelViewer.setAttribute("auto-rotate", "");
            modelViewer.setAttribute("ar", "");
            modelViewer.setAttribute("autoplay", "");
            modelViewer.setAttribute("loop", "");

            container.appendChild(modelViewer);

            // Create a new div to hold the buttons
            const buttonsDiv = document.createElement('div');
            buttonsDiv.id = "download-buttons";
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.flexWrap = 'wrap';
            buttonsDiv.style.justifyContent = 'center';

            // Create and append download buttons
            const fileTypes = ['PNG', 'VRM', 'FBX', 'USDZ', 'GLB'];
            let urls = [metadata.image, metadata.vrm_url, metadata.fbx_url, metadata.usdz_url, metadata.animation_url];

            if (needsMint) {
                urls = urls.map(url => url.replace('/public/', '/private/'));
            }

            fileTypes.forEach((type, index) => {
                const button = document.createElement('button');
                button.id = type.toLowerCase() + '-btn';

                // If needsMint is true, append a ðŸ”’ to 'VRM' and 'FBX'
                const label = (needsMint && (type === 'VRM' || type === 'FBX')) ? `${type} ðŸ”’` : type;
                button.textContent = label;

                if (needsMint && (type === 'FBX' || type === 'VRM')) {
                    button.disabled = true;
                    button.style.opacity = 0.5;
                } else {
                    button.addEventListener("click", () => downloadFile(urls[index], type));
                }

                buttonsDiv.appendChild(button);
            });

            // Add Mint text and button if needed
            if (needsMint) {
                const mintText = document.createElement('p');
                mintText.textContent = "Mint this avatar to unlock all file types & play in OnCyber:";
                buttonsDiv.appendChild(mintText);

                const mintButton = document.createElement('button');
                mintButton.textContent = "Mint";
                mintButton.addEventListener("click", () => window.open("https://mferavatars.xyz"));
                buttonsDiv.appendChild(mintButton);
            }

            container.appendChild(buttonsDiv);  // Append the new div to models-container

            // Function to create model viewer and buttons
            const createModelAndButtons = async (itemId, name, fileTypes) => {
              // Construct the URL for the first fileType
                const firstUrl = `${baseUrl}assets/extras/${name}/${fileTypes[0].toLowerCase()}/${itemId}.${fileTypes[0].toLowerCase()}`;

                // Perform a 'HEAD' request to check if the file exists
                const response = await fetch(firstUrl);

                // If the first file type is available, proceed to add the model and buttons
                if (response.ok) {
                    const modelContainer = document.createElement('div');
                    modelContainer.classList.add('model-container');

                    const modelViewer = document.createElement("model-viewer");
                    modelViewer.style.backgroundColor = `#${bgColor}`; // Ensure bgColor is defined or set a default value
                    modelViewer.setAttribute("src", `${baseUrl}assets/extras/${name}/glb/${itemId}.glb`);
                    modelViewer.setAttribute("ios-src", `${baseUrl}assets/extras/${name}/usdz/${itemId}.usdz`);
                    modelViewer.setAttribute("alt", `mfer #${itemId}`);
                    modelViewer.setAttribute("ar-status", "not-presenting");
                    modelViewer.setAttribute("shadow-intensity", "1");
                    modelViewer.setAttribute("camera-controls", "");
                    modelViewer.setAttribute("auto-rotate", "");
                    modelViewer.setAttribute("ar", "");
                    modelViewer.setAttribute("autoplay", "");
                    modelViewer.setAttribute("loop", "");

                    modelContainer.appendChild(modelViewer);

                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.classList.add('download-buttons');
                    buttonsDiv.style.display = 'flex';
                    buttonsDiv.style.flexWrap = 'wrap';
                    buttonsDiv.style.justifyContent = 'center';

                    // Update the urls construction to use the provided fileTypes
                    const urls = fileTypes.map(type =>
                        `${baseUrl}assets/extras/${name}/${type.toLowerCase()}/${itemId}.${type.toLowerCase()}`
                    );

                    // Update the loop to use the provided fileTypes
                    fileTypes.forEach((type, index) => {
                        const button = document.createElement('button');
                        button.id = `${name}-${type.toLowerCase()}-${itemId}-btn`;
                        button.textContent = type;
                        button.addEventListener("click", () => downloadFile(urls[index], type));
                        buttonsDiv.appendChild(button);
                    });

                    modelContainer.appendChild(buttonsDiv);
                    container.appendChild(modelContainer);
                  }
            };

            // Create model and buttons for each extra item
            extraItems.forEach(async (item) => {
              await createModelAndButtons(id, item.name, item.fileTypes);
            });
        }

        function downloadFile(url, type) {
            if (url) {
                const link = document.createElement('a');
                link.href = url;
                link.download = url.split('/').pop();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                gtag('event', 'download', {
                    'event_category': 'button_click',
                    'event_label': 'Download ' + type + ' Button - ID: ' + id
                });
            }
        }
    </script>
</head>
<body>
  <!-- Add placeholder for the header at the top -->
  <a id="mainHeader" href="" style="text-decoration: none; color: inherit;">
        <h1></h1>
    </a>
    <h1 id="dynamicHeader"></h1>
    <div id="card">
        <div id="models-container"></div>
    </div>
    <div class="metadata"></div>
    <h1 id="dynamicHeader"></h1>
    <div id="card">
        <div id="models-container"></div>
    </div>
    <div class="metadata"></div>
</body>
</html>
