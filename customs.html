<!DOCTYPE html>
<html lang="en">
 <head>
  <!-- Google tag (gtag.js) -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DEMRCQSGLC">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DEMRCQSGLC');
  </script>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   mfer avatars
  </title>
  <link href="demo-styles.css" rel="stylesheet"/>
  <script defer="" src="https://github.com/lightlessdays/web-ar/blob/main/focus.js">
  </script>
  <script src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js" type="module">
  </script>
  <link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAK0lEQVQ4jWNgGAWjYBSMglEwCkbBSAcACBAAAeaR9MDwTVgZ4Q9II7CfSAb8DBhGwQgABJ5A8V7i4hkAAAAASUVORK5CYII=" rel="icon" type="image/png"/>
 </head>
 <body>
  <h1 style="text-align:center; margin: 20px 0;">
   mfer avatars: customs
  </h1>
  <div style="text-align:center; margin: 20px 0;">
   <a href="https://www.mferavatars.xyz" style=" margin: 20px 20px; padding: 10px 20px; background-color: #007BFF; color: #fff; border-radius: 5px; text-decoration: none; font-weight: bold;">
    Mint Here
   </a>
   <a href="https://ar.mferavatars.xyz" style=" margin: 20px 20px; padding: 10px 20px; background-color: #007BFF; color: #fff; border-radius: 5px; text-decoration: none; font-weight: bold;">
    OG mfer avatars
   </a>
   <h4 style="text-align:center; margin: 20px 0;">
    Open this page on your phone to view mfers in AR!
   </h4>
  </div>
  <div id="new-models-container" style="display: flex; justify-content: center; align-items: baseline;">
    <!-- The new 3D models will go here -->
  </div>
  <div id="card">
   <div style="text-align:center; margin-bottom: 20px;">
    <label for="mferID">
     Enter custom mfer ID:
    </label>
    <input id="mferID" placeholder="1234" type="text"/>
    <button onclick="onSearchPressed()" style="">
     Search
    </button>
   </div>
   <div id="models-container">
   </div>
  </div>
  <script type="module">
   const color_map = {
        "red": "ff7277",
        "green": "b7ff6c",
        "yellow": "ffe25e",
        "orange": "feb66e",
        "blue": "5cd3ff",
        "turquoise": "4487a3",
        "purple": "e175ff",
        "tree": "ffe25f",
        "space": "898989",
        "graveyard": "7c7c7c"
    };

    async function fetchModels() {
        const response = await fetch("https://cybermfers.sfo3.digitaloceanspaces.com/?prefix=cybermfers/customs/public/metadata/");
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");
        const keys = xmlDoc.getElementsByTagName("Key");
        const mintedMfers = {};

        for (let i = 0; i < keys.length; i++) {
            const key = keys[i].textContent;
            const basename = key.split('.')[0];
            const ext = key.split('.')[1];

            if (ext === 'json') {
                const metadataUrl = `https://cybermfers.sfo3.digitaloceanspaces.com/${key}`;
                const metadataResponse = await fetch(metadataUrl);
                const metadata = await metadataResponse.json();

                const id = basename.split('/').pop();

                // const glb = metadata.animation_url;
                // const usdz = metadata.usdz_url;
                const glb = `https://cybermfers.sfo3.digitaloceanspaces.com/cybermfers/customs/public/assets/extras/christmas/glb/${id}.glb`;
                const usdz = `https://cybermfers.sfo3.digitaloceanspaces.com/cybermfers/customs/public/assets/extras/christmas/usdz/${id}.usdz`;

                const container = document.getElementById("models-container");

                const custom = metadata.attributes.find(attr => attr.trait_type === "custom");

                if (usdz && glb && !custom) {
                    const modelViewer = document.createElement("model-viewer");
                    modelViewer.setAttribute("src", glb);
                    modelViewer.setAttribute("ios-src", usdz);
                    modelViewer.setAttribute("alt", `${basename}`);
                    modelViewer.setAttribute("ar-status", "not-presenting");
                    modelViewer.setAttribute("shadow-intensity", "1");
                    modelViewer.setAttribute("camera-controls", "");
                    modelViewer.setAttribute("auto-rotate", "");
                    modelViewer.setAttribute("ar", "");
                    modelViewer.setAttribute("autoplay", "");
                    modelViewer.setAttribute("loop", "");

                    let bgColor = "FFFFFF";
                    const backgroundTrait = metadata.attributes.find(attr => attr.trait_type === "background");

                    if (backgroundTrait) {
                        bgColor = color_map[backgroundTrait.value] || "FFFFFF";
                    }
                    metadata.background_color = bgColor;

                    modelViewer.style.backgroundColor = `#${bgColor}`;
                    container.appendChild(modelViewer);

                    const detailButton = document.createElement("button");
                    detailButton.onclick = function() { window.location.href = `details.html?id=${id}&custom=true`; };
                    detailButton.textContent = `view all custom mfer #${id}`; detailButton.style.width = "calc(100% - 20px)"; detailButton.style.marginTop = "10px"; detailButton.style.padding = "10px"; detailButton.style.backgroundColor = "#007BFF"; detailButton.style.color = "#fff"; detailButton.style.border = "1px solid #ccc"; detailButton.style.cursor = "pointer"; detailButton.style.borderRadius = "5px"; detailButton.style.display = "block"; detailButton.style.marginLeft = "auto"; detailButton.style.marginRight = "auto";
                    container.appendChild(detailButton);
                }
            }
        }
    }

    window.onload = fetchModels;

    // Custom examples
    document.addEventListener("DOMContentLoaded", function() {
      // Define new model ids and their background colors
      const newModels = [
        { id: "mcx", color: "green" },
        { id: "pcmfer", color: "purple" },
        { id: "s34n", color: "yellow" }
      ];

      const newModelsContainer = document.getElementById("new-models-container");

      // Create model-viewer elements for each new model
      newModels.forEach(model => {
        const modelViewer = document.createElement("model-viewer");
        modelViewer.setAttribute("src", `https://cybermfers.sfo3.digitaloceanspaces.com/cybermfers/customs/public/assets/glb/${model.id}.glb`);
        modelViewer.setAttribute("ios-src", `https://cybermfers.sfo3.digitaloceanspaces.com/cybermfers/customs/public/assets/usdz/${model.id}.usdz`);
        modelViewer.setAttribute("alt", `${model.id}`);
        modelViewer.setAttribute("ar-status", "not-presenting");
        modelViewer.setAttribute("shadow-intensity", "1");
        modelViewer.setAttribute("camera-controls", "");
        modelViewer.setAttribute("ar", "");
        modelViewer.setAttribute("autoplay", "");
        modelViewer.setAttribute("loop", "");

        const bgColor = color_map[model.color] || "FFFFFF";
        modelViewer.style.backgroundColor = `#${bgColor}`;
        newModelsContainer.appendChild(modelViewer);
      });
    });

  </script>
  <script>
  function onSearchPressed() {
     const id = document.getElementById("mferID").value;

     fetch('https://cybermfers.sfo3.digitaloceanspaces.com/?prefix=cybermfers/customs/public/metadata/')
         .then(response => response.text())
         .then(data => {
             const parser = new DOMParser();
             const xml = parser.parseFromString(data, 'application/xml');
             const files = xml.querySelectorAll('Key');
             let metadataFile;

             files.forEach(file => {
                 if (file.textContent === `cybermfers/customs/public/metadata/${id}.json`) {
                     metadataFile = file.textContent;
                 }
             });

             if (metadataFile) {
                 return fetch(`https://cybermfers.sfo3.digitaloceanspaces.com/${metadataFile}`)
                     .then(response => response.json())
                     .then(metadata => {
                         if (metadata.name !== 'custom mfer') {
                             window.location.href = `details.html?id=${id}&custom=true`;
                         } else {
                           let modalResponse = confirm('That avatar is not minted. Do you want to mint it?');
                           if (modalResponse) {
                               window.location.href = 'https://www.mferavatars.xyz';
                           }
                         }
                     });
             } else {
                 let modalResponse = confirm('That avatar is not minted. Do you want to mint it?');
                 if (modalResponse) {
                     window.location.href = 'https://www.mferavatars.xyz';
                 }
             }
         })
         .catch(error => console.error('Error:', error));
  }

  </script>
 </body>
</html>
